# node P-Touch

Brotherのラベルプリンター「P-Touch」への印刷をSPAなどのウェブアプリから行うという試みです。実際に使ってみると、サクサクと印刷できて便利なので公開してみます。

現状動作するのはQL-720NW（おそらくQL-820NWBも）になります。原理的には他のモデルも対応が可能なはずですが、現時点で対応の予定はございません（実機もありませんので…）。

## はじめに

Brotherからは[P-Touch Editor](https://www.brother.co.jp/product/labelprinter/pteditor50/index.aspx)というデスクトップアプリ（WindowsとMac OS）が用意されています。操作性にやや癖(?)がありますが、画面上で印刷内容をレイアウトして手軽に印刷したり、内蔵の簡易データベースやスプレッドシートなどで用意したデータを読み込んで差し込み印刷も可能です。

また、b-PACと呼ばれるWindowsプラットフォーム向けのSDKも用意されており、Microsoft Office、VBAやC#.Netなどから直接印刷制御も可能です。

その他の環境から印刷をしたい場合は、現時点ではとくにSDKなどは用意されておらず、上記のb-PACを利用したなんらかのProxyサーバを用意するのがBrotherで推奨している方法です。Windows上でASP.Netなどを利用して書く必要があるようです。

## 仕組み

QLシリーズが対応している印刷方法は下記のとおりとなります。

- ラスター印刷
    - いわゆるビットマップ画像を直接送りつける方法で、きれいに印刷するとスピードが遅いですがどんなデータでも印刷可能です。
- テンプレート印刷
    - 先のP-Touch Editorでテンプレートを作成し、予めプリンターに登録しておく。送るのはテンプレートを埋める文字情報だけなので高速に印刷が可能。ただし、安価に販売されている海外モデルには漢字フォントが登録されていないため、文字化けするみたいです。
- ESC/P印刷
    - 長い歴史を持つESC/Pコードが活用する印刷モードです。ビットマップはもちろん内蔵フォントも使用可能、コマンド一つでバーコードやQRコードも印刷可能です。ただし、ESC/Pという黒魔術をマスターなければなりません。

今回の試みで採用した方法はラスター印刷になります。クライアント上のSPAで印刷したいラベルのデータをPNG画像として生成し、適当なWebフレームワーク（今回はENode.jsとExpress）に実装されたサーバー上から、IPPプロトコルを使用してラベルプリンターに印刷します。

当初はJSからラベルプリンターへ直接印刷ができないものかと思ったのですが、どうやらCUPSサーバはセキュリティ上の理由により、CORSを利用したリクエストを受け付けない仕様になっています。

### 対象となるラベルプリンターのモデル
- QL-720NW
	- https://www.brother.co.jp/product/labelprinter/ql720nw/index.aspx
	- 旧モデルですでに製造中止のようです
- QL-820NWB
	- https://www.brother.co.jp/product/labelprinter/ql820nwb/index.aspx
	- 現時点で２色ラベルには対応していません
	- 現行モデルですが執筆時点ではACアダプタの不具合のためか入手困難となっています…

### IPPプロプロトコル
### 印刷データの生成
クライアント側で何らかの形で印刷したいラベルに合わせた印刷用データをPNG形式にて作成します。最終的に2値化処理を施すのでモノクロでデザインしておきます。

画像データのサイズは、幅は必ず`720px`になります。縦方向は、カットラベル場合は規定のピックセル数、ロール紙の場合は長さに合わせて任意（`150 - 1000px`）のピクセル数を指定します。縦方向のみですが、高解像度(600DPI)で印刷可能で、その場合は倍のピクセル数となります。

例１　29mm x 90mm の場合は`720 x 908`
例２　50mm x 180mmの場合は`720 x 1816`
例３　29mm x 90mmで高解像度の場合は`720 x 1816`

とても大事なのが印刷対象を描く位置が、一般のプリンターと異なり右側にオフセットする必要があるということです。QLシリーズは熱転写式のプリンターで、サーマルヘッドが本体の下側にありますので、ラベル用紙は印刷面を下側にして給紙されます。したがって原点は本体正面に対して左側にあるため、細いテープの場合は右側の部分が印刷対象となります。



ウェブアプリからのラベル

比較的安価なUSB接続オンリーのP-Touchを使う場合、以下の2つの方法が考えられます：
- 適当なサーバーやRaspberry PiなどにUSB接続し、プリントサーバー（CUPS）を立ち上げてIPP経由にて印刷する。
- NodeJsからUSBをいじることも難しくはなさそうなので、適当なサーバーやRaspberry PiなどにUSB接続し、USB経由で直接印刷する。

いずれも適当なサーバーが必要となり、設定の手間もかかるため、ネットワーク機能を内蔵したP-Touchシリーズを利用したほうが簡単かなとは思います。
## P-Touch QLシリーズの特徴
## 課題
P-Touchとの通信はIPP経由ですので、より手頃なUSB接続のみのQL-800などには直接は対応していません。試してはいないですが、適当なPCやラズベリーパイをサーバーとしてUSB接続接続し、CUPSサーバーを走らせれば動くんんじゃないかと思います。また、そこまでするならCORS制約も回避できるので、ウェブアプリから直接の印刷も可能かと思います。
また、Node.JSからUSBを制御するライブラリ[tessel/node-usb]も存在しますので、こちらを利用すれば少しの修正でUSBを経由で直接印刷できるかと思います。
